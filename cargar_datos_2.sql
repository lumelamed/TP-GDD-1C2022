-- PRIMER TABLA DE SCRIPT. 
-- CIRCUITO
INSERT INTO COSMICOS.CIRCUITO (CIRCUITO_CODIGO, CIRCUITO_NOMBRE, CIRCUITO_PAIS)
SELECT DISTINCT CIRCUITO_CODIGO, CIRCUITO_NOMBRE, CIRCUITO_PAIS 
FROM gd_esquema.Maestra 
ORDER BY CIRCUITO_CODIGO

-- CARRERA
INSERT INTO COSMICOS.CARRERA (CODIGO_CARRERA, CIRCUITO_CODIGO, CARRERA_FECHA, CARRERA_CLIMA, CARRERA_TOTAL_CARRERA, CARRERA_CANT_VUELTAS) 
SELECT DISTINCT CODIGO_CARRERA, CIRCUITO_CODIGO, CARRERA_FECHA, CARRERA_CLIMA, CARRERA_TOTAL_CARRERA, CARRERA_CANT_VUELTAS
FROM gd_esquema.Maestra

--TIPO SECTOR
INSERT INTO COSMICOS.TIPO_SECTOR (DESCRIPCION)
SELECT  DISTINCT  SECTO_TIPO
FROM gd_esquema.Maestra 

--SECTOR
INSERT INTO COSMICOS.SECTOR (CODIGO_SECTOR, SECTRO_DISTANCIA, SECTOR_TIPO, CIRCUITO_CODIGO)
SELECT DISTINCT CODIGO_SECTOR, SECTOR_DISTANCIA, ts.SECTOR_TIPO, CIRCUITO_CODIGO
FROM gd_esquema.Maestra m
JOIN COSMICOS.TIPO_SECTOR ts ON m.SECTO_TIPO = ts.DESCRIPCION
ORDER BY CODIGO_SECTOR

--PILOTO
INSERT INTO COSMICOS.PILOTO 
(PILOTO_NOMBRE, PILOTO_APELLIDO, PILOTO_FECHA_NACIMIENTO, PILOTO_NACIONALIDAD)
SELECT DISTINCT PILOTO_NOMBRE, UPPER(PILOTO_APELLIDO) AS APELLIDO, PILOTO_FECHA_NACIMIENTO, PILOTO_NACIONALIDAD 
FROM gd_esquema.Maestra 
ORDER BY PILOTO_FECHA_NACIMIENTO

-- ESCUDERIA
INSERT INTO COSMICOS.ESCUDERIA 
(ESCUDERIA_NOMBRE, ESCUDERIA_NACIONALIDAD)
SELECT DISTINCT ESCUDERIA_NOMBRE, ESCUDERIA_NACIONALIDAD 
FROM gd_esquema.Maestra 

-------- PARTES DEL AUTO ------------

-- MOTOR
INSERT INTO COSMICOS.MOTOR 
(MOTOR_NRO_SERIE, MOTOR_MODELO)
SELECT DISTINCT TELE_MOTOR_NRO_SERIE, TELE_MOTOR_MODELO 
FROM gd_esquema.Maestra 
WHERE TELE_MOTOR_NRO_SERIE IS NOT NULL

-- CAJA
INSERT INTO COSMICOS.CAJA 
(CAJA_NRO_SERIE, CAJA_MODELO)
SELECT DISTINCT TELE_CAJA_NRO_SERIE, TELE_CAJA_MODELO 
FROM gd_esquema.Maestra 
WHERE TELE_CAJA_NRO_SERIE IS NOT NULL

-- FRENOS
INSERT INTO COSMICOS.FRENO 
(FRENO_NRO_SERIE, FRENO_POSICION, FRENO_TAMANIO_DISCO)
SELECT DISTINCT TELE_FRENO1_NRO_SERIE, TELE_FRENO1_POSICION, TELE_FRENO1_TAMANIO_DISCO 
FROM gd_esquema.Maestra 
WHERE TELE_FRENO1_NRO_SERIE IS NOT NULL
UNION
SELECT DISTINCT TELE_FRENO2_NRO_SERIE, TELE_FRENO2_POSICION, TELE_FRENO2_TAMANIO_DISCO 
FROM gd_esquema.Maestra 
WHERE TELE_FRENO2_NRO_SERIE IS NOT NULL
UNION
SELECT DISTINCT TELE_FRENO3_NRO_SERIE, TELE_FRENO3_POSICION, TELE_FRENO3_TAMANIO_DISCO 
FROM gd_esquema.Maestra 
WHERE TELE_FRENO3_NRO_SERIE IS NOT NULL
UNION
SELECT DISTINCT TELE_FRENO4_NRO_SERIE, TELE_FRENO4_POSICION, TELE_FRENO4_TAMANIO_DISCO 
FROM gd_esquema.Maestra
WHERE TELE_FRENO4_NRO_SERIE IS NOT NULL  

-- TIPO NEUMATICO
INSERT INTO COSMICOS.TIPO_NEUMATICO (DESCRIPCION)
SELECT  DISTINCT  NEUMATICO1_TIPO_NUEVO
FROM gd_esquema.Maestra 
WHERE NEUMATICO1_TIPO_NUEVO IS NOT NULL
UNION
SELECT  DISTINCT  NEUMATICO1_TIPO_VIEJO
FROM gd_esquema.Maestra 
WHERE NEUMATICO1_TIPO_VIEJO IS NOT NULL
UNION
SELECT  DISTINCT  NEUMATICO2_TIPO_NUEVO
FROM gd_esquema.Maestra 
WHERE NEUMATICO2_TIPO_NUEVO IS NOT NULL
UNION
SELECT  DISTINCT  NEUMATICO2_TIPO_VIEJO
FROM gd_esquema.Maestra 
WHERE NEUMATICO2_TIPO_VIEJO IS NOT NULL
UNION
SELECT  DISTINCT  NEUMATICO3_TIPO_NUEVO
FROM gd_esquema.Maestra 
WHERE NEUMATICO3_TIPO_NUEVO IS NOT NULL
UNION
SELECT  DISTINCT  NEUMATICO3_TIPO_VIEJO
FROM gd_esquema.Maestra 
WHERE NEUMATICO3_TIPO_VIEJO IS NOT NULL
UNION
SELECT  DISTINCT  NEUMATICO4_TIPO_NUEVO
FROM gd_esquema.Maestra 
WHERE NEUMATICO4_TIPO_NUEVO IS NOT NULL
UNION
SELECT  DISTINCT  NEUMATICO4_TIPO_VIEJO
FROM gd_esquema.Maestra 
WHERE NEUMATICO4_TIPO_VIEJO IS NOT NULL

-- NEUMATICO
INSERT INTO COSMICOS.NEUMATICO (NEUMATICO_NRO_SERIE, NEUMATICO_POSICION, NEUMATICO_TIPO)
SELECT DISTINCT NEUMATICO1_NRO_SERIE_NUEVO, NEUMATICO1_POSICION_NUEVO, tn.NEUMATICO_TIPO
FROM gd_esquema.Maestra m
JOIN COSMICOS.TIPO_NEUMATICO tn ON m.NEUMATICO1_TIPO_NUEVO = tn.DESCRIPCION
UNION
SELECT DISTINCT NEUMATICO1_NRO_SERIE_VIEJO, NEUMATICO1_POSICION_VIEJO, tn.NEUMATICO_TIPO
FROM gd_esquema.Maestra m
JOIN COSMICOS.TIPO_NEUMATICO tn ON m.NEUMATICO1_TIPO_VIEJO = tn.DESCRIPCION
UNION
SELECT DISTINCT NEUMATICO2_NRO_SERIE_NUEVO, NEUMATICO2_POSICION_NUEVO, tn.NEUMATICO_TIPO
FROM gd_esquema.Maestra m
JOIN COSMICOS.TIPO_NEUMATICO tn ON m.NEUMATICO2_TIPO_NUEVO = tn.DESCRIPCION
UNION 
SELECT DISTINCT NEUMATICO2_NRO_SERIE_VIEJO, NEUMATICO2_POSICION_VIEJO, tn.NEUMATICO_TIPO
FROM gd_esquema.Maestra m
JOIN COSMICOS.TIPO_NEUMATICO tn ON m.NEUMATICO2_TIPO_VIEJO = tn.DESCRIPCION
UNION
SELECT DISTINCT NEUMATICO3_NRO_SERIE_NUEVO, NEUMATICO3_POSICION_NUEVO, tn.NEUMATICO_TIPO
FROM gd_esquema.Maestra m
JOIN COSMICOS.TIPO_NEUMATICO tn ON m.NEUMATICO3_TIPO_NUEVO = tn.DESCRIPCION
UNION
SELECT DISTINCT NEUMATICO3_NRO_SERIE_VIEJO, NEUMATICO3_POSICION_VIEJO, tn.NEUMATICO_TIPO
FROM gd_esquema.Maestra m
JOIN COSMICOS.TIPO_NEUMATICO tn ON m.NEUMATICO3_TIPO_VIEJO = tn.DESCRIPCION
UNION
SELECT DISTINCT NEUMATICO4_NRO_SERIE_NUEVO, NEUMATICO4_POSICION_NUEVO, tn.NEUMATICO_TIPO
FROM gd_esquema.Maestra m
JOIN COSMICOS.TIPO_NEUMATICO tn ON m.NEUMATICO4_TIPO_NUEVO = tn.DESCRIPCION
UNION
SELECT DISTINCT NEUMATICO4_NRO_SERIE_VIEJO, NEUMATICO4_POSICION_VIEJO, tn.NEUMATICO_TIPO
FROM gd_esquema.Maestra m
JOIN COSMICOS.TIPO_NEUMATICO tn ON m.NEUMATICO4_TIPO_VIEJO = tn.DESCRIPCION
ORDER BY 1

-- AUTO
INSERT INTO COSMICOS.AUTO (AUTO_NUMERO, AUTO_MODELO , CODIGO_PILOTO , CODIGO_ESCUDERIA , MOTOR_NRO_SERIE, CAJA_NRO_SERIE)
SELECT DISTINCT M.AUTO_NUMERO,M.AUTO_MODELO,P.CODIGO_PILOTO,E.CODIGO_ESCUDERIA,M.TELE_MOTOR_NRO_SERIE,M.TELE_CAJA_NRO_SERIE
FROM gd_esquema.Maestra AS M
JOIN COSMICOS.PILOTO AS P on P.PILOTO_NOMBRE = M.PILOTO_NOMBRE and P.PILOTO_APELLIDO = UPPER(M.PILOTO_APELLIDO)
JOIN COSMICOS.ESCUDERIA AS E ON E.ESCUDERIA_NOMBRE = M.ESCUDERIA_NOMBRE and E.ESCUDERIA_NACIONALIDAD = M.ESCUDERIA_NACIONALIDAD
WHERE M.TELE_MOTOR_NRO_SERIE IS NOT NULL AND M.TELE_CAJA_NRO_SERIE IS NOT NULL

-- NEUMATICO_POR_AUTO
                BEGIN TRAN AAA
          -- hacer rollback despues porque no anda todavia !!!!!!!!!!!!!!!!!!!
                INSERT INTO COSMICOS.NEUMATICO_POR_AUTO (NEUMATICO_NRO_SERIE, CODIGO_AUTO, ACTIVO)
                SELECT DISTINCT NEUMATICO1_NRO_SERIE_NUEVO, a.CODIGO_AUTO, 0
                FROM gd_esquema.Maestra m
                JOIN COSMICOS.AUTO a ON m.AUTO_NUMERO = a.AUTO_NUMERO AND m.AUTO_MODELO = a.AUTO_MODELO
                WHERE NEUMATICO1_NRO_SERIE_NUEVO IS NOT NULL
                UNION
                SELECT DISTINCT NEUMATICO1_NRO_SERIE_VIEJO, a.CODIGO_AUTO, 0
                FROM gd_esquema.Maestra m
                JOIN COSMICOS.AUTO a ON m.AUTO_NUMERO = a.AUTO_NUMERO AND m.AUTO_MODELO = a.AUTO_MODELO
                WHERE NEUMATICO1_NRO_SERIE_VIEJO IS NOT NULL
                UNION
                SELECT DISTINCT NEUMATICO2_NRO_SERIE_NUEVO, a.CODIGO_AUTO, 0
                FROM gd_esquema.Maestra m
                JOIN COSMICOS.AUTO a ON m.AUTO_NUMERO = a.AUTO_NUMERO AND m.AUTO_MODELO = a.AUTO_MODELO
                WHERE NEUMATICO2_NRO_SERIE_NUEVO IS NOT NULL
                UNION 
                SELECT DISTINCT NEUMATICO2_NRO_SERIE_VIEJO, a.CODIGO_AUTO, 0
                FROM gd_esquema.Maestra m
                JOIN COSMICOS.AUTO a ON m.AUTO_NUMERO = a.AUTO_NUMERO AND m.AUTO_MODELO = a.AUTO_MODELO
                WHERE NEUMATICO2_NRO_SERIE_VIEJO IS NOT NULL
                UNION
                SELECT DISTINCT NEUMATICO3_NRO_SERIE_NUEVO, a.CODIGO_AUTO, 0
                FROM gd_esquema.Maestra m
                JOIN COSMICOS.AUTO a ON m.AUTO_NUMERO = a.AUTO_NUMERO AND m.AUTO_MODELO = a.AUTO_MODELO
                WHERE NEUMATICO3_NRO_SERIE_NUEVO IS NOT NULL
                UNION
                SELECT DISTINCT NEUMATICO3_NRO_SERIE_VIEJO, a.CODIGO_AUTO, 0
                FROM gd_esquema.Maestra m
                JOIN COSMICOS.AUTO a ON m.AUTO_NUMERO = a.AUTO_NUMERO AND m.AUTO_MODELO = a.AUTO_MODELO
                WHERE NEUMATICO3_NRO_SERIE_VIEJO IS NOT NULL
                UNION
                SELECT DISTINCT NEUMATICO4_NRO_SERIE_NUEVO, a.CODIGO_AUTO, 0
                FROM gd_esquema.Maestra m
                JOIN COSMICOS.AUTO a ON m.AUTO_NUMERO = a.AUTO_NUMERO AND m.AUTO_MODELO = a.AUTO_MODELO
                WHERE NEUMATICO4_NRO_SERIE_NUEVO IS NOT NULL
                UNION
                SELECT DISTINCT NEUMATICO4_NRO_SERIE_VIEJO, a.CODIGO_AUTO, 0
                FROM gd_esquema.Maestra m
                JOIN COSMICOS.AUTO a ON m.AUTO_NUMERO = a.AUTO_NUMERO AND m.AUTO_MODELO = a.AUTO_MODELO
                WHERE NEUMATICO4_NRO_SERIE_VIEJO IS NOT NULL
                ORDER BY 2

                -- revisar
                DECLARE @auto_num int, @auto_modelo nvarchar(255), @cod int
                DECLARE CURSOR_AUTOS CURSOR FOR 
                SELECT AUTO_MODELO, AUTO_NUMERO, CODIGO_AUTO FROM COSMICOS.AUTO
                OPEN CURSOR_AUTOS
                FETCH NEXT FROM CURSOR_AUTOS INTO @auto_modelo, @auto_num, @cod
                  WHILE @@FETCH_STATUS = 0
                    BEGIN
                      DECLARE @neu1 nvarchar(255), @neu2 nvarchar(255), @neu3 nvarchar(255), @neu4 nvarchar(255)

                      SELECT DISTINCT @neu1 = NEUMATICO1_NRO_SERIE_NUEVO, 
                              @neu2 = NEUMATICO2_NRO_SERIE_NUEVO, 
                              @neu3 = NEUMATICO3_NRO_SERIE_NUEVO, 
                              @neu4 = NEUMATICO4_NRO_SERIE_NUEVO 
                              FROM [gd_esquema].[Maestra] m
                              WHERE AUTO_MODELO = @auto_modelo AND AUTO_NUMERO = @auto_num 
                              AND  NEUMATICO1_NRO_SERIE_NUEVO IS NOT NULL
                              AND  NEUMATICO2_NRO_SERIE_NUEVO IS NOT NULL
                              AND  NEUMATICO3_NRO_SERIE_NUEVO IS NOT NULL
                              AND  NEUMATICO4_NRO_SERIE_NUEVO IS NOT NULL

                      -- este "print" se ve en la tab de Messages de SQL Server
                      PRINT 'PARA EL AUTO ' + CAST(@cod as varchar) + ' LOS NUEMATICOS ACTIVOS SON ' + 
                        CAST(@neu1 as varchar) + ', ' +  CAST(@neu2 as varchar) + ', ' + CAST(@neu3 as varchar) + ', ' + CAST(@neu4 as varchar)

                      UPDATE COSMICOS.NEUMATICO_POR_AUTO
                      SET ACTIVO = 1
                      WHERE NEUMATICO_NRO_SERIE in (@neu1, @neu2, @neu3, @neu4) AND CODIGO_AUTO = @cod

                      FETCH NEXT FROM CURSOR_AUTOS INTO @auto_modelo, @auto_num, @cod
                    END
                CLOSE CURSOR_AUTOS
                DEALLOCATE CURSOR_AUTOS

                -- creo que le falta una vuelta de tuerca porque deberia haber 4 neumaticos activos por auto, y hay muchos
                select CODIGO_AUTO, count(activo)
                from COSMICOS.NEUMATICO_POR_AUTO
                group by CODIGO_AUTO
                order by CODIGO_AUTO

-- TIPO INCIDENTE
INSERT INTO COSMICOS.TIPO_INCIDENTE
SELECT DISTINCT INCIDENTE_TIPO FROM gd_esquema.Maestra WHERE INCIDENTE_TIPO IS NOT NULL

-- BANDERA
INSERT INTO COSMICOS.BANDERA
SELECT DISTINCT INCIDENTE_BANDERA FROM gd_esquema.Maestra WHERE INCIDENTE_BANDERA IS NOT NULL
